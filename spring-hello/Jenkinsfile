pipeline {
    agent any

    environment {
        E2E_PORT = '8086'
        PROD_PORT = '9090'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('spring-hello') {
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Unit Test') {
            steps {
                dir('spring-hello') {
                    bat 'mvn test'
                }
            }
        }

        stage('Run App for E2E Test') {
            steps {
                dir('spring-hello') {
                    bat 'start /b java -jar target/*.jar --server.port=8086'
                    // Wait for app to start
                    bat 'ping -n 10 127.0.0.1 > nul'
                }
            }
        }

        stage('Install Playwright Dependencies') {
            steps {
                dir('spring-hello') {
                    bat 'npm install'
                }
            }
        }

        stage('E2E Test') {
            steps {
                dir('spring-hello') {
                    bat 'npx playwright test'
                }
            }
        }

        stage('Stop Test App') {
            steps {
                // Kill the Java process on the E2E port
                bat 'FOR /F "tokens=5" %%A IN (\'netstat -aon ^| findstr :%E2E_PORT%\') DO taskkill /PID %%A /F'
            }
        }

        stage('Deploy to Production') {
            steps {
                dir('spring-hello') {
                    bat 'start /b java -jar target/*.jar --server.port=%PROD_PORT%'
                }
            }
        }
    }
}
