pipeline {
    agent any

    environment {
        E2E_PORT = '8086'
        PROD_PORT = '9090'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('spring-hello') {
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Unit Test') {
            steps {
                dir('spring-hello') {
                    bat 'mvn test'
                }
            }
        }

        stage('Run App for E2E Test') {
            steps {
                dir('spring-hello') {
                    bat "start /b java -jar target/*.jar --server.port=%E2E_PORT%"
                    bat 'timeout /t 10'
                }
            }
        }

        stage('Install Playwright Dependencies') {
            steps {
                dir('spring-hello') {
                    bat 'npm install'
                }
            }
        }

        stage('E2E Test') {
            steps {
                dir('spring-hello') {
                    bat 'npx playwright test'
                }
            }
        }

        stage('Stop Test App') {
            steps {
                bat 'FOR /F "tokens=5" %%A IN (\'netstat -aon ^| findstr :%E2E_PORT%\') DO taskkill /PID %%A /F'
            }
        }

        stage('Deploy to Production') {
            steps {
                dir('spring-hello') {
                    bat "start /b java -jar target/*.jar --server.port=%PROD_PORT%"
                }
            }
        }
    }
}
