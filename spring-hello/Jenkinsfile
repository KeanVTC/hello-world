pipeline {
    agent any

    environment {
        IMAGE_NAME = 'springboot-ci-demo'
        CONTAINER_NAME = 'springboot-ci-container'
        APP_PORT = '8086'
        PROD_IMAGE_NAME = 'springboot-prod-image'
        PROD_CONTAINER_NAME = 'springboot-prod-container'
        PROD_PORT = '9090'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                bat 'mvn clean package -DskipTests'
            }
        }

        stage('Unit Test') {
            steps {
                bat 'mvn test'
            }
        }

        stage('Run App for E2E Test') {
            steps {
                bat """
                    docker stop %CONTAINER_NAME% || exit 0
                    docker rm %CONTAINER_NAME% || exit 0
                    docker build -t %IMAGE_NAME% .
                    docker run -d -p %APP_PORT%:8080 --name %CONTAINER_NAME% %IMAGE_NAME%
                """
                sleep time: 15, unit: 'SECONDS' // Give the app time to start
            }
        }

        stage('Install Playwright Dependencies') {
            steps {
                dir('spring-hello/playwright-tests') {
                    bat 'npm ci'
                    bat 'npx playwright install'
                }
            }
        }

        stage('E2E Test') {
            steps {
                dir('spring-hello/playwright-tests') {
                    bat 'npx playwright test'
                }
            }
        }

        stage('Stop Test App') {
            steps {
                bat 'docker stop %CONTAINER_NAME% || exit 0'
                bat 'docker rm %CONTAINER_NAME% || exit 0'
            }
        }

        stage('Deploy to Production') {
            steps {
                bat """
                    docker stop %PROD_CONTAINER_NAME% || exit 0
                    docker rm %PROD_CONTAINER_NAME% || exit 0
                    docker build -t %PROD_IMAGE_NAME% .
                    docker run -d -p %PROD_PORT%:8080 --name %PROD_CONTAINER_NAME% %PROD_IMAGE_NAME%
                """
            }
        }
    }
}
