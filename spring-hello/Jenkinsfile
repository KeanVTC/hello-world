pipeline {
    agent any

    environment {
        TEST_CONTAINER = 'spring-hello-container'
        PROD_CONTAINER = 'spring-prod-container'
        INTERNAL_PORT = '8086'
        TEST_PORT = '9090'
        PROD_PORT = '9091'
    }

    stages {
        stage('Build Spring Boot App') {
            steps {
                dir('spring-hello') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Start Test Container') {
            steps {
                sh '''
                docker rm -f $TEST_CONTAINER || true
                docker build -t spring-hello-image spring-hello
                docker run -d --name $TEST_CONTAINER -p $TEST_PORT:$INTERNAL_PORT spring-hello-image
                '''
                sleep 10
            }
        }

        stage('Install Playwright') {
            steps {
                dir('spring-hello') {
                    sh 'npm ci'
                    sh 'npx playwright install --with-deps'
                }
            }
        }

        stage('Run Playwright Tests') {
            steps {
                dir('spring-hello') {
                    sh 'npx playwright test'
                }
            }
        }

        stage('Archive Playwright Report') {
            steps {
                dir('spring-hello/playwright-tests') {
                    // No need to open browser — just generate report
                    sh 'npx playwright show-report --output=playwright-report'
                    archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true
                }
            }
        }

        stage('Stop Test Container') {
            steps {
                sh 'docker rm -f $TEST_CONTAINER || true'
            }
        }

        stage('Deploy to Production') {
            steps {
                sh '''
                docker rm -f $PROD_CONTAINER || true
                docker run -d --name $PROD_CONTAINER -p $PROD_PORT:$INTERNAL_PORT spring-hello-image
                '''
            }
        }
    }

    post {
        always {
            echo "✅ CI/CD complete. To view the Playwright test report:"
            echo "➡ Go to this Jenkins build → Artifacts → playwright-report → index.html"
        }
    }
}
